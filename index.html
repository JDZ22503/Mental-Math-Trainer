<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Mental Math Trainer</title>
	<style>
		:root {
			--bg: #0f1115;
			--panel: #1c2129;
			--panel-alt: #242b35;
			--accent: #4dabf7;
			--accent-alt: #845ef7;
			--danger: #fa5252;
			--ok: #51cf66;
			--text: #e9ecef;
			--muted: #94a2b8;
			--warn: #fcc419;
			--radius: 14px;
			font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif;
		}

		* {
			box-sizing: border-box;
		}

		body {
			margin: 0;
			background: linear-gradient(145deg, #10141a, #06070a);
			color: var(--text);
			min-height: 100dvh;
			display: flex;
			flex-direction: column;
		}

		header {
			padding: 1rem clamp(.5rem, 2vw, 2rem);
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 1rem;
			flex-wrap: wrap;
		}

		h1 {
			font-size: clamp(1.2rem, 2.2vw, 1.9rem);
			margin: 0;
			font-weight: 600;
			letter-spacing: .5px;
		}

		#app {
			width: 100%;
			max-width: 900px;
			margin: 0 auto;
			padding: 0 1rem 2.5rem;
			flex: 1;
			display: flex;
			flex-direction: column;
		}

		.panel {
			background: linear-gradient(145deg, var(--panel), var(--panel-alt));
			border: 1px solid #2c3440;
			border-radius: var(--radius);
			padding: clamp(1rem, 2.5vw, 2rem);
			box-shadow: 0 4px 18px -6px rgba(0, 0, 0, .6), 0 0 0 1px #1a2027 inset;
			position: relative;
			overflow: hidden;
		}

		.topic-grid {
			display: grid;
			gap: 1rem;
			grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
			margin-top: 1rem;
		}

		button {
			cursor: pointer;
			font: inherit;
			border: none;
			border-radius: 10px;
			padding: .85rem 1rem;
			background: var(--accent);
			color: #fff;
			font-weight: 600;
			letter-spacing: .5px;
			position: relative;
			outline: none;
			transition: .25s cubic-bezier(.4, 0, .2, 1);
			box-shadow: 0 4px 12px -4px rgba(0, 0, 0, .7), 0 0 0 1px rgba(255, 255, 255, .06) inset;
		}

		button.topic {
			background: linear-gradient(160deg, var(--accent), var(--accent-alt));
		}

		button:hover:not([disabled]) {
			transform: translateY(-2px);
			box-shadow: 0 6px 18px -6px rgba(0, 0, 0, .8), 0 0 0 1px rgba(255, 255, 255, .08) inset;
		}

		button:active:not([disabled]) {
			transform: translateY(0);
		}

		button.secondary {
			background: var(--panel-alt);
			color: var(--text);
			border: 1px solid #344050;
		}

		button.secondary:hover {
			background: #2b3340;
		}

		.question-area {
			margin-top: 1.2rem;
		}

		.question {
			font-size: clamp(1.6rem, 3.8vw, 3rem);
			font-weight: 600;
			text-align: center;
			margin: 0 0 1.1rem;
			letter-spacing: 2px;
		}

		.options {
			display: grid;
			gap: .85rem;
			grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
		}

		.option {
			background: #223;
			border: 1px solid #2f3a49;
			color: var(--text);
			font-weight: 600;
			font-size: 1.05rem;
		}

		.option.correct {
			background: var(--ok) !important;
			color: #0e3018;
			border-color: #58d56e;
		}

		.option.wrong {
			background: var(--danger) !important;
			border-color: #ff6b6b;
		}

		.option.disabled {
			filter: grayscale(.5) brightness(.7);
			cursor: default;
		}

		.option:focus-visible {
			outline: 2px solid var(--accent);
			outline-offset: 2px;
		}

		.meta-bar {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 1rem;
			flex-wrap: wrap;
			margin-top: .3rem;
		}

		.pill {
			background: #202830;
			padding: .55rem .9rem;
			border-radius: 40px;
			font-size: .85rem;
			display: inline-flex;
			align-items: center;
			gap: .5ch;
			letter-spacing: .5px;
			border: 1px solid #2c3743;
		}

		.timer {
			font-weight: 700;
			font-size: 1rem;
			min-width: 70px;
			text-align: right;
		}

		.timer.low {
			color: var(--danger);
			animation: pulse .9s infinite alternate;
		}

		@keyframes pulse {
			from {
				transform: scale(1);
				opacity: .9;
			}

			to {
				transform: scale(1.09);
				opacity: 1;
			}
		}

		.score-big {
			font-size: 2.8rem;
			font-weight: 700;
			margin: .2rem 0 0;
			text-align: center;
			background: linear-gradient(90deg, var(--accent), var(--accent-alt));
			-webkit-background-clip: text;
			background-clip: text;
			color: transparent;
		}

		.fade-in {
			animation: fade .5s ease;
		}

		@keyframes fade {
			from {
				opacity: 0;
				transform: translateY(6px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.mini {
			font-size: .75rem;
			opacity: .7;
		}

		.divider {
			height: 1px;
			background: #2a313b;
			margin: 1.25rem 0;
		}

		a.inline {
			color: var(--accent);
			text-decoration: none;
		}

		a.inline:hover {
			text-decoration: underline;
		}

		.flex-row {
			display: flex;
			gap: .75rem;
			flex-wrap: wrap;
		}

		.grow {
			flex: 1;
		}

		.hidden {
			display: none !important;
		}

		footer {
			padding: 1.1rem 1rem;
			font-size: .75rem;
			opacity: .65;
			text-align: center;
		}

		@media (max-width:600px) {
			.question {
				letter-spacing: 1px;
			}

			.options {
				grid-template-columns: repeat(2, 1fr);
			}
		}

		/* Grade cards styling */
		.grade-cards {
			display: flex;
			gap: 1rem;
			flex-wrap: wrap;
			margin: .5rem 0 1rem;
		}

		.grade-card {
			flex: 1 1 260px;
			background: linear-gradient(145deg, var(--panel), var(--panel-alt));
			border: 1px solid #2c3440;
			border-radius: 12px;
			padding: 1rem;
			cursor: pointer;
			transition: .25s cubic-bezier(.4, 0, .2, 1);
			box-shadow: 0 4px 14px -6px rgba(0, 0, 0, .6);
		}

		.grade-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 20px -8px rgba(0, 0, 0, .7);
		}

		.grade-card.selected {
			outline: 2px solid var(--accent);
			box-shadow: 0 0 0 2px rgba(77, 171, 247, .25), 0 10px 24px -10px rgba(77, 171, 247, .25);
		}

		.grade-card h3 {
			margin: .1rem 0 .25rem;
			font-size: 1.05rem;
			letter-spacing: .4px;
		}

		.grade-card p {
			margin: 0;
			color: var(--muted);
			font-size: .85rem;
		}

		/* Answer feedback animations */
		@keyframes pop-in {
			0% {
				transform: scale(.98);
			}

			60% {
				transform: scale(1.06);
			}

			100% {
				transform: scale(1);
			}
		}

		@keyframes shake {

			0%,
			100% {
				transform: translateX(0);
			}

			20% {
				transform: translateX(-4px);
			}

			40% {
				transform: translateX(4px);
			}

			60% {
				transform: translateX(-3px);
			}

			80% {
				transform: translateX(3px);
			}
		}

		.option.correct {
			animation: pop-in .35s ease;
		}

		.option.wrong {
			animation: shake .35s ease;
		}
	</style>
</head>

<body>
	<header>
		<h1>Mental Math Trainer</h1>
		<div class="flex-row" id="headerRight">
			<div class="pill" id="totalScorePill" title="Total Points">üèÜ <span id="totalScore">0</span></div>
			<div class="pill" id="accuracyPill" title="Accuracy">üéØ <span id="accuracy">0%</span></div>
			<div class="pill" id="streakPill" title="Current Streak">üî• <span id="streak">0</span></div>
			<div class="pill timer" id="timerDisplay">10.0s</div>
		</div>
	</header>

	<main id="app">
		<!-- START SCREEN -->
		<section id="startScreen" class="panel fade-in">
			<h2 style="margin:0 0 .35rem; font-size:1.5rem;">Choose a Topic</h2>
			<p style="margin:0 0 1rem; color:var(--muted); max-width:680px;">Sharpen your mental arithmetic. Pick an
				operation to begin. Answer quickly for more points. Each question has a 10 second timer. Wrong or
				timed‚Äëout answers give no points. Score decays with time‚Äîbe quick but accurate!</p>
			<!-- Grade selection cards -->
			<div class="grade-cards" id="gradeCards">
				<div class="grade-card" data-grade="1-5" tabindex="0" role="button" aria-pressed="false">
					<h3>Grade 1‚Äì5</h3>
					<p>Two-digit numbers for + ‚àí √ó √∑</p>
				</div>
				<div class="grade-card" data-grade="6-10" tabindex="0" role="button" aria-pressed="false">
					<h3>Grade 6‚Äì10</h3>
					<p>Up to three-digit numbers for + ‚àí √ó √∑</p>
				</div>
			</div>
			<div class="topic-grid" id="topicGrid"></div>
			<div class="divider"></div>
			<!-- Session configuration -->
			<div style="display:flex; flex-wrap:wrap; gap:1rem; align-items:flex-end; margin-bottom:.9rem;">
				<div style="min-width:140px;">
					<label
						style="font-size:.65rem; letter-spacing:.5px; text-transform:uppercase; opacity:.65; display:block; margin-bottom:.25rem;">Questions</label>
					<select id="questionCountSelect"
						style="width:140px; padding:.55rem .6rem; background:#1d2430; border:1px solid #2f3a48; border-radius:8px; color:var(--text);">
						<option value="10">10</option>
						<option value="20">20</option>
						<option value="30" selected>30</option>
						<option value="50">50</option>
						<option value="0">Infinite</option>
					</select>
				</div>
				<label
					style="display:flex; align-items:center; gap:.5rem; font-size:.7rem; background:#1b222b; padding:.55rem .8rem; border-radius:8px; border:1px solid #2b3440; cursor:pointer;">
					<input type="checkbox" id="autoNextToggle" checked style="accent-color:var(--accent);"> Auto Next
				</label>
				<div class="mini" style="opacity:.65; max-width:360px;">Ends & summary shows when question count reached
					(ignored in Practice & Multiplayer). Disable Auto Next for manual pacing.</div>
			</div>
			<div class="flex-row">
				<button id="randomMix" class="secondary grow" title="Randomly mixes all operations">üé≤ Random
					Mix</button>
				<button id="startPractice" class="secondary" title="Practice loop without scoring">Practice
					Mode</button>
				<button id="gotoMultiplayer" class="secondary" title="Play with others (beta)">Multiplayer</button>
			</div>
		</section>

		<!-- MULTIPLAYER LOBBY -->
		<section id="mpLobby" class="panel hidden">
			<h2 style="margin:0 0 .5rem; font-size:1.45rem;">Multiplayer Lobby</h2>
			<p class="mini" style="margin:0 0 1rem;">Create a room or join an existing one. Share the 6‚Äëletter code.
				Host starts the game. Everyone gets identical questions & a shared timer.</p>
			<div class="flex-row" style="gap:1rem; align-items:flex-end; flex-wrap:wrap;">
				<div style="flex:1; min-width:180px;">
					<label style="font-size:.7rem; letter-spacing:.5px; text-transform:uppercase; opacity:.7;">Display
						Name</label>
					<input id="mpName" placeholder="Your name"
						style="width:100%; padding:.6rem .7rem; background:#1d2430; border:1px solid #2f3a48; border-radius:8px; color:var(--text);"
						maxlength="18" />
				</div>
				<div style="min-width:130px;">
					<label style="font-size:.7rem; letter-spacing:.5px; text-transform:uppercase; opacity:.7;">Room
						Code</label>
					<input id="mpCode" placeholder="ABC123"
						style="width:100%; padding:.6rem .7rem; background:#1d2430; border:1px solid #2f3a48; border-radius:8px; color:var(--text); text-transform:uppercase;"
						maxlength="6" />
				</div>
				<div style="min-width:140px;">
					<label
						style="font-size:.7rem; letter-spacing:.5px; text-transform:uppercase; opacity:.7;">Questions</label>
					<select id="mpQuestionLimit"
						style="width:100%; padding:.6rem .55rem; background:#1d2430; border:1px solid #2f3a48; border-radius:8px; color:var(--text);">
						<option value="10" selected>10</option>
						<option value="20">20</option>
						<option value="30">30</option>
						<option value="50">50</option>
						<option value="0">Infinite</option>
					</select>
				</div>
			</div>
			<div class="flex-row" style="margin-top:1rem;">
				<button id="mpCreate" class="grow">Create Room</button>
				<button id="mpJoin" class="secondary grow">Join Room</button>
			</div>
			<div id="mpStatus" class="mini" style="margin-top:.75rem; color:var(--muted);"></div>
			<div class="divider"></div>
			<button id="backFromMp" class="secondary">‚Üê Back</button>
		</section>

		<!-- MULTIPLAYER ROOM -->
		<section id="mpRoom" class="panel hidden">
			<div class="meta-bar" style="align-items:flex-start;">
				<div style="flex:1;">
					<h2 style="margin:.2rem 0 .3rem; font-size:1.2rem;">Room <span id="roomCodeDisp"></span></h2>
					<div class="mini" id="hostHint" style="opacity:.7;">Waiting for host to start‚Ä¶</div>
				</div>
				<div>
					<button id="mpStart" disabled>Start Game</button>
				</div>
			</div>
			<div class="divider" style="margin: .8rem 0 1rem;"></div>
			<div class="flex-row" style="align-items:stretch; gap:1rem;">
				<div style="flex:2; min-width:250px;">
					<p class="question" id="mpQuestion" style="min-height:3.2rem;">‚Äî</p>
					<div class="options" id="mpOptions"></div>
				</div>
				<div style="flex:1; display:flex; flex-direction:column; gap:1rem; min-width:240px; max-width:280px;">
					<div>
						<h3
							style="margin:.3rem 0 .4rem; font-size:.9rem; font-weight:600; letter-spacing:.5px; text-transform:uppercase; opacity:.75;">
							Leaderboard</h3>
						<div id="mpLeaderboard"
							style="font-size:.8rem; line-height:1.35; background:#192029; border:1px solid #2a313c; padding:.6rem .7rem; border-radius:10px; min-height:140px; max-height:180px; overflow:auto;">
						</div>
					</div>
					<div>
						<h3
							style="margin:.3rem 0 .4rem; font-size:.9rem; font-weight:600; letter-spacing:.5px; text-transform:uppercase; opacity:.75;">
							Chat</h3>
						<div id="mpChatLog"
							style="font-size:.7rem; line-height:1.35; background:#181f27; border:1px solid #25313d; padding:.55rem .55rem .6rem; border-radius:10px; min-height:130px; max-height:190px; overflow-y:auto; word-wrap:break-word;">
							<em style="opacity:.5;">No messages yet.</em>
						</div>
						<form id="mpChatForm" style="display:flex; gap:.4rem; margin-top:.5rem;" autocomplete="off">
							<input id="mpChatInput" placeholder="Type message..." maxlength="200"
								style="flex:1; padding:.55rem .65rem; background:#1d2430; border:1px solid #2f3a48; border-radius:8px; color:var(--text); font-size:.7rem;" />
							<button type="submit" class="secondary"
								style="padding:.55rem .8rem; font-size:.7rem;">Send</button>
						</form>
					</div>
				</div>
			</div>
			<div class="divider"></div>
			<div class="flex-row">
				<button id="leaveRoom" class="secondary">Leave Room</button>
			</div>
		</section>

		<!-- QUIZ SCREEN -->
		<section id="quizScreen" class="panel hidden">
			<div class="meta-bar">
				<div class="pill" id="topicLabel">‚ûó Division</div>
				<div class="pill" id="gradePill" title="Difficulty range">üéì <span id="gradeText">1‚Äì5</span></div>
				<div class="pill" id="perQuestionScore" title="Points just earned">+0</div>
			</div>
			<div class="question-area">
				<p class="question" id="questionText">7 + 5 = ?</p>
				<div class="options" id="options"></div>
			</div>
			<div class="divider"></div>
			<div class="flex-row">
				<button id="nextBtn" class="grow" disabled>Next ‚ûú</button>
				<button id="changeTopicBtn" class="secondary">Change Topic</button>
				<button id="resetBtn" class="secondary" title="Reset all progress">Reset</button>
			</div>
		</section>

		<!-- SUMMARY SCREEN -->
		<section id="summaryScreen" class="panel hidden">
			<h2 style="margin:.2rem 0 0; font-size:1.5rem;">Session Summary</h2>
			<p class="score-big" id="finalScore">0</p>
			<div class="flex-row" style="justify-content:center; margin-top:.5rem; flex-wrap:wrap;">
				<div class="pill">Questions: <span id="sumQuestions">0</span></div>
				<div class="pill">Correct: <span id="sumCorrect">0</span></div>
				<div class="pill">Accuracy: <span id="sumAccuracy">0%</span></div>
				<div class="pill">Avg Time: <span id="sumAvgTime">0.0s</span></div>
				<div class="pill">Best Streak: <span id="sumBestStreak">0</span></div>
			</div>
			<div class="divider"></div>
			<div class="flex-row">
				<button id="playAgain" class="grow">Continue</button>
				<button id="backHome" class="secondary">Topics</button>
			</div>
		</section>
	</main>
	<footer>Made for quick mental math practice. Keyboard: 1‚Äë4 to answer, N for Next, Esc to topics.</footer>

	<!-- Winner Announcement Overlay -->
	<div id="winnerOverlay" class="hidden"
		style="position:fixed; inset:0; backdrop-filter:blur(6px); background:rgba(10,14,20,.78); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:999; padding:2rem; text-align:center;">
		<div class="winner-card"
			style="position:relative; background:linear-gradient(145deg,#1d2632,#141a22); border:1px solid #2d3946; border-radius:28px; padding:2.2rem clamp(1.4rem,4vw,3rem) 2.4rem; max-width:620px; width:100%; box-shadow:0 10px 35px -10px rgba(0,0,0,.8),0 0 0 1px rgba(255,255,255,.04) inset;">
			<h2 id="winnerTitle"
				style="margin:0 0 1rem; font-size:clamp(1.6rem,4.5vw,2.7rem); letter-spacing:1px; background:linear-gradient(90deg,var(--accent),var(--accent-alt)); -webkit-background-clip:text; background-clip:text; color:transparent; animation:winner-pop .9s ease;">
				Winner</h2>
			<p id="winnerNames"
				style="margin:.2rem 0 1.4rem; font-size:clamp(1.1rem,2.7vw,1.6rem); font-weight:600; line-height:1.3;">
				Player</p>
			<div id="finalLeaderboard"
				style="font-size:.85rem; line-height:1.35; text-align:left; max-height:240px; overflow:auto; padding:.75rem .9rem; background:#111923; border:1px solid #25303c; border-radius:14px; margin:0 auto 1.6rem;">
			</div>
			<div style="display:flex; gap:.85rem; flex-wrap:wrap; justify-content:center;">
				<button id="closeWinner" class="secondary">Close</button>
				<button id="restartRoom" style="display:none;">Restart</button>
			</div>
			<div class="mini" style="margin-top:1rem; opacity:.55;">Host can restart to play another round.</div>
			<div id="confettiContainer" aria-hidden="true"
				style="position:absolute; inset:0; overflow:hidden; pointer-events:none; border-radius:inherit;"></div>
		</div>
	</div>

	<style>
		@keyframes winner-pop {
			0% {
				transform: scale(.6) translateY(20px);
				opacity: 0;
			}

			60% {
				transform: scale(1.08) translateY(-4px);
				opacity: 1;
			}

			100% {
				transform: scale(1) translateY(0);
			}
		}

		@keyframes confetti-fall {
			0% {
				transform: translate3d(var(--x-start), -10%, 0) rotateZ(0deg) rotateY(0deg);
				opacity: 0;
			}

			6% {
				opacity: 1;
			}

			100% {
				transform: translate3d(var(--x-end), 110%, 0) rotateZ(var(--rot)) rotateY(360deg);
				opacity: 0;
			}
		}

		.confetti-piece {
			position: absolute;
			top: 0;
			width: 10px;
			height: 14px;
			background: var(--c);
			opacity: 0;
			animation: confetti-fall var(--dur) linear forwards;
			border-radius: 2px;
			box-shadow: 0 0 0 1px rgba(255, 255, 255, .1) inset;
		}
	</style>

	<script>
		/* Mental Math Trainer
			 Features:
				 - Topic selection (addition, subtraction, multiplication, division, random mix)
				 - Random MCQ with 4 choices (1 correct + 3 unique distractors)
				 - 10 second timer per question (adjustable constant)
				 - Speed-based scoring (linear decay)
				 - Streaks, accuracy, average time, session summary
				 - Practice mode (no scoring) & full reset
				 - Accessible: buttons focusable, keyboard shortcuts indicated in footer
		 */

		const TOPICS = [
			{ id: 'add', label: 'Addition', symbol: '+', generator: genAddition },
			{ id: 'sub', label: 'Subtraction', symbol: '‚àí', generator: genSubtraction },
			{ id: 'mul', label: 'Multiplication', symbol: '√ó', generator: genMultiplication },
			{ id: 'div', label: 'Division', symbol: '√∑', generator: genDivision },
		];

		// Settings
		const QUESTION_TIME_MS = 10000; // 10s per question
		const MAX_POINTS = 100;         // Max points if instant answer
		const MIN_POINTS = 10;          // Min points if answered just before timeout
		const AUTO_NEXT_DELAY = 700;    // ms after answer before auto moving (if Next not clicked)
		const SUMMARY_EVERY = 15;       // Show summary every X answered questions

		// State
		let chosenTopics = []; // array of topic objects for the session (can be multiple if random)
		let practiceMode = false;
		let currentQuestion = null;
		let questionStart = 0;
		let timerInterval = null;
		let timeLeftMs = QUESTION_TIME_MS;
		let totalScore = 0;
		let questions = 0;
		let correct = 0;
		let totalAnswerTime = 0; // sum of ms for correct answers
		let streak = 0; let bestStreak = 0;
		let answeredThisSession = 0;
		let questionLimit = Infinity; // user selected
		let autoNextEnabled = true;
		let selectedGradeRange = '1-5'; // default

		// DOM references
		const el = id => document.getElementById(id);
		const topicGrid = el('topicGrid');
		const startScreen = el('startScreen');
		const quizScreen = el('quizScreen');
		const summaryScreen = el('summaryScreen');
		const optionsContainer = el('options');
		const questionText = el('questionText');
		const perQuestionScore = el('perQuestionScore');
		const timerDisplay = el('timerDisplay');
		const totalScoreEl = el('totalScore');
		const accuracyEl = el('accuracy');
		const streakEl = el('streak');
		const topicLabel = el('topicLabel');
		const gradePill = el('gradePill');
		const gradeText = el('gradeText');
		const nextBtn = el('nextBtn');
		const changeTopicBtn = el('changeTopicBtn');
		const resetBtn = el('resetBtn');
		const randomMixBtn = el('randomMix');
		const practiceBtn = el('startPractice');
		const playAgainBtn = el('playAgain');
		const backHomeBtn = el('backHome');
		// Add new controls
		const questionCountSelect = el('questionCountSelect');
		const autoNextToggle = el('autoNextToggle');
		// Multiplayer elements
		const gotoMultiplayerBtn = el('gotoMultiplayer');
		const mpLobby = el('mpLobby');
		const mpRoom = el('mpRoom');
		const mpCreate = el('mpCreate');
		const mpJoin = el('mpJoin');
		const mpName = el('mpName');
		const mpCode = el('mpCode');
		const mpStatus = el('mpStatus');
		const backFromMp = el('backFromMp');
		const mpStart = el('mpStart');
		const mpQuestion = el('mpQuestion');
		const mpOptions = el('mpOptions');
		const mpLeaderboard = el('mpLeaderboard');
		const leaveRoomBtn = el('leaveRoom');
		const roomCodeDisp = el('roomCodeDisp');
		const hostHint = el('hostHint');
		const mpQuestionLimit = el('mpQuestionLimit');
		// Summary elements
		const finalScore = el('finalScore');
		const sumQuestions = el('sumQuestions');
		const sumCorrect = el('sumCorrect');
		const sumAccuracy = el('sumAccuracy');
		const sumAvgTime = el('sumAvgTime');
		const sumBestStreak = el('sumBestStreak');

		// Build topic buttons
		TOPICS.forEach(t => {
			const b = document.createElement('button');
			b.className = 'topic';
			b.textContent = t.label;
			b.addEventListener('click', () => startSession([t]));
			topicGrid.appendChild(b);
		});

		randomMixBtn.addEventListener('click', () => startSession([...TOPICS]));
		practiceBtn.addEventListener('click', () => { practiceMode = true; startSession([...TOPICS]); });
		changeTopicBtn.addEventListener('click', showStart);
		resetBtn.addEventListener('click', fullReset);
		nextBtn.addEventListener('click', () => { if (!nextBtn.disabled) nextQuestion(); });
		playAgainBtn.addEventListener('click', () => { hide(summaryScreen); show(quizScreen); nextQuestion(); });
		backHomeBtn.addEventListener('click', () => { hide(summaryScreen); showStart(); });

		// Grade card behavior
		const gradeCards = document.getElementById('gradeCards');
		function setSelectedGrade(grade) {
			selectedGradeRange = grade;
			[...gradeCards.querySelectorAll('.grade-card')].forEach(card => {
				const is = card.dataset.grade === grade;
				card.classList.toggle('selected', is);
				card.setAttribute('aria-pressed', String(is));
			});
			if (gradeText) { gradeText.textContent = grade === '1-5' ? '1‚Äì5' : '6‚Äì10'; }
		}
		if (gradeCards) {
			gradeCards.addEventListener('click', (e) => {
				const card = e.target.closest('.grade-card');
				if (!card) return;
				setSelectedGrade(card.dataset.grade);
			});
			gradeCards.addEventListener('keydown', (e) => {
				if (e.key !== 'Enter' && e.key !== ' ') return;
				const card = e.target.closest('.grade-card'); if (!card) return; e.preventDefault(); setSelectedGrade(card.dataset.grade);
			});
			// default select first
			setSelectedGrade('1-5');
		}
		// Multiplayer nav
		gotoMultiplayerBtn.addEventListener('click', () => { hide(startScreen); show(mpLobby); });
		backFromMp.addEventListener('click', () => { showStart(); hide(mpLobby); });

		// Multiplayer logic
		// let ws = null; let mpPlayerId=null; let mpHostId=null; let mpCurrentQuestion=null; let mpAnswerLocked=false; let inRoom=false; let isHost=false;
		// // Robust WebSocket URL builder supports file:// usage (falls back to localhost)
		// const WS_URL = (() => {
		// 	if(location.protocol.startsWith('http')) {
		// 		const isLocal = location.hostname==='localhost' || location.hostname==='127.0.0.1';
		// 		const scheme = location.protocol==='https:'? 'wss://':'ws://';
		// 		if(isLocal) return scheme + 'localhost:3000';
		// 		const hostNoPort = location.hostname;
		// 		return scheme + hostNoPort + ':3000';
		// 	} else {
		// 		// file:// or other ‚Äì assume local dev server
		// 		return 'ws://localhost:3000';
		// 	}
		// })();
		// let wsSendQueue = [];
		let ws = null;
		let mpPlayerId = null;
		let mpHostId = null;
		let mpCurrentQuestion = null;
		let mpAnswerLocked = false;
		let inRoom = false;
		let isHost = false;

		// Build robust WebSocket URL
		// - If served over HTTPS, use wss to the same host (works with nginx TLS termination on 443)
		// - If served over HTTP, use ws to the same host
		// - If opened from file:// or running locally without host, fall back to ws://localhost:3000
		const WS_URL = (() => {
			// Use production server if on mental-math-trainer.shreesbacademy.tech
			if (location.protocol === 'https:') return `wss://mental-math-trainer.shreesbacademy.tech/socket.io/`;
			if (location.protocol === 'http:') return `ws://${location.hostname}:3000/socket.io/`;
			return 'ws://localhost:3000/socket.io/';
		})();

		let wsSendQueue = [];
		function initWS() {
			if (ws && ws.readyState === 1) return;
			ws = new WebSocket(WS_URL);
			ws.onopen = () => {
				statusMsg('Connected to server.'); sendName(); // flush queued messages
				wsSendQueue.forEach(m => { try { ws.send(JSON.stringify({ type: m.type, ...m.obj })); } catch { } });
				wsSendQueue = [];
			};
			ws.onclose = () => {
				statusMsg('Disconnected.'); if (inRoom) { // fallback to lobby
					show(mpLobby); hide(mpRoom); inRoom = false;
				}
			};
			ws.onerror = () => statusMsg('Connection error.');
			ws.onmessage = e => { const msg = JSON.parse(e.data); handleWs(msg); };
		}
		function handleWs(m) {
			switch (m.type) {
				case 'hello': mpPlayerId = m.playerId; break;
				case 'error': statusMsg('Error: ' + m.message, true); break;
				case 'room_created': inRoom = true; isHost = true; mpHostId = m.hostId; roomCodeDisp.textContent = m.code; statusMsg('Room created. Share code: ' + m.code + (m.limit ? ' | ' + m.limit + ' Qs' : '')); showRoom(); break;
				case 'joined': inRoom = true; mpHostId = m.hostId; isHost = (mpPlayerId === mpHostId); roomCodeDisp.textContent = m.code; statusMsg('Joined room ' + m.code + (m.limit ? ' | ' + m.limit + ' Qs' : '')); showRoom(); break;
				case 'player_join': updateLeaderboard(m.leaderboard); break;
				case 'leaderboard': updateLeaderboard(m.leaderboard); break;
				case 'host_change': mpHostId = m.hostId; isHost = (mpPlayerId === mpHostId); updateStartButton(); break;
				case 'question': mpCurrentQuestion = m.question; renderMpQuestion(m.question, m.index, m.total); updateLeaderboard(m.leaderboard); mpAnswerLocked = false; break;
				case 'reveal': if (mpCurrentQuestion && m.questionId === mpCurrentQuestion.id) { revealMp(m.answer); updateLeaderboard(m.leaderboard); } break;
				case 'end_game': statusMsg('Game finished.'); mpCurrentQuestion = null; updateStartButton(); showWinnerAnnouncement(m.leaderboard); break;
				case 'chat': appendChatMessage(m.message); break;
				case 'chat_history': if (Array.isArray(m.messages)) m.messages.forEach(msg => appendChatMessage(msg, true)); break;
			}
		}
		const mpChatLog = el('mpChatLog');
		const mpChatForm = el('mpChatForm');
		const mpChatInput = el('mpChatInput');
		// Global error capture to surface unexpected issues that might block chat rendering
		window.addEventListener('error', ev => { console.error('[global error]', ev.message, ev.filename, ev.lineno); });
		window.addEventListener('unhandledrejection', ev => { console.error('[promise rejection]', ev.reason); });
		function showRoom() { hide(mpLobby); show(mpRoom); updateStartButton(); }
		function updateStartButton() { mpStart.disabled = !isHost || (mpCurrentQuestion != null); hostHint.textContent = isHost ? (mpCurrentQuestion ? 'Game running‚Ä¶' : 'You are host. Start when ready.') : (mpCurrentQuestion ? 'Game running‚Ä¶' : 'Waiting for host‚Ä¶'); }
		function statusMsg(t, err = false) { mpStatus.textContent = t; mpStatus.style.color = err ? 'var(--danger)' : 'var(--muted)'; }
		function send(type, obj) {
			if (ws && ws.readyState === 1) {
				ws.send(JSON.stringify({ type, ...obj }));
			} else {
				wsSendQueue.push({ type, obj });
			}
		}
		function sendName() { const name = (mpName.value || 'Player').trim(); send('set_name', { name }); }
		mpName.addEventListener('change', sendName);
		mpCreate.addEventListener('click', () => { initWS(); sendName(); const limit = parseInt(mpQuestionLimit.value, 10); send('create_room', { topics: TOPICS.map(t => t.id), limit: limit > 0 ? limit : null }); });
		mpJoin.addEventListener('click', () => { const code = mpCode.value.trim().toUpperCase(); if (!code) { statusMsg('Enter room code.', true); return; } initWS(); sendName(); send('join_room', { code }); });
		mpStart.addEventListener('click', () => { if (isHost) { mpCurrentQuestion = null; send('start', {}); } });
		leaveRoomBtn.addEventListener('click', () => { location.reload(); });
		if (mpChatForm) {
			mpChatForm.addEventListener('submit', e => {
				e.preventDefault();
				const v = mpChatInput.value.trim();
				if (!v) return;
				console.debug('[chat] send', v);
				// optimistic append (will be duplicated when server echoes; we tag pending)
				appendChatMessage({ name: mpName.value || 'You', text: v, ts: Date.now(), _pending: true });
				send('chat', { text: v });
				mpChatInput.value = '';
			});
		}

		function renderMpQuestion(q, index, total) {
			mpQuestion.textContent = (total ? `[${index}/${total}] ` : '') + q.text;
			mpOptions.innerHTML = '';
			q.options.forEach((val, i) => {
				const btn = document.createElement('button'); btn.className = 'option'; btn.textContent = val; btn.addEventListener('click', () => mpSelect(val, btn)); mpOptions.appendChild(btn);
			});
			setupMpTimer(q);
		}
		function mpSelect(val, btn) { if (mpAnswerLocked) return; mpAnswerLocked = true; send('answer', { questionId: mpCurrentQuestion.id, choice: val }); highlightPending(btn); }
		function highlightPending(btn) { [...mpOptions.children].forEach(b => b.disabled = true); btn.classList.add('disabled'); }
		function revealMp(answer) { // if timer not finished, buffer
			if (mpCurrentQuestion) {
				const now = Date.now();
				if (now < mpCurrentQuestion.start + mpCurrentQuestion.duration - 30) { pendingReveal = { id: mpCurrentQuestion.id, answer }; return; }
			}
			applyReveal(answer);
		}
		function applyReveal(answer) { [...mpOptions.children].forEach(b => { const v = +b.textContent; if (v === answer) b.classList.add('correct'); else if (!b.classList.contains('disabled')) b.classList.add('disabled'); }); mpCurrentQuestion = null; updateStartButton(); }

		// Winner announcement logic
		const winnerOverlay = document.getElementById('winnerOverlay');
		const winnerTitle = document.getElementById('winnerTitle');
		const winnerNamesEl = document.getElementById('winnerNames');
		const finalLeaderboardEl = document.getElementById('finalLeaderboard');
		const closeWinnerBtn = document.getElementById('closeWinner');
		const restartRoomBtn = document.getElementById('restartRoom');
		const confettiContainer = document.getElementById('confettiContainer');

		closeWinnerBtn.addEventListener('click', () => { winnerOverlay.classList.add('hidden'); });
		restartRoomBtn.addEventListener('click', () => { winnerOverlay.classList.add('hidden'); if (isHost) { send('start', {}); } });

		function showWinnerAnnouncement(leaderboard) {
			if (!Array.isArray(leaderboard) || !leaderboard.length) return;
			const topScore = leaderboard[0].score;
			const winners = leaderboard.filter(p => p.score === topScore);
			winnerTitle.textContent = winners.length > 1 ? 'Winners!' : 'Winner!';
			winnerNamesEl.textContent = winners.map(w => w.name).join(', ');
			finalLeaderboardEl.innerHTML = leaderboard.map((p, i) => `
				<div style="display:grid; grid-template-columns:32px 1fr 80px 60px; gap:.4rem; align-items:center; padding:.35rem .25rem; border-radius:8px; background:${i < 3 ? 'rgba(77,171,247,.07)' : 'transparent'};">
					<span style="font-weight:600; opacity:.8;">${i + 1}</span>
					<span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(p.name)}</span>
					<span style="text-align:right; font-weight:600;">${p.score}</span>
					<span style="text-align:right; opacity:.7; font-size:.7rem;">${p.correct}/${p.questions || p.correct}</span>
				</div>`).join('');
			winnerOverlay.classList.remove('hidden');
			restartRoomBtn.style.display = isHost ? 'inline-block' : 'none';
			launchConfetti();
		}

		function launchConfetti() {
			confettiContainer.innerHTML = '';
			const colors = ['#4dabf7', '#845ef7', '#51cf66', '#fcc419', '#ff6b6b', '#ffa8a8'];
			const pieces = 120;
			for (let i = 0; i < pieces; i++) {
				const d = document.createElement('div');
				d.className = 'confetti-piece';
				const c = colors[i % colors.length];
				const xStart = (Math.random() * 100).toFixed(2) + '%';
				const xEnd = (parseFloat(xStart) + (Math.random() * 20 - 10)).toFixed(2) + '%';
				const rot = (Math.random() * 720 - 360).toFixed(0) + 'deg';
				const dur = (5 + Math.random() * 3).toFixed(2) + 's';
				d.style.setProperty('--c', c);
				d.style.setProperty('--x-start', xStart);
				d.style.setProperty('--x-end', xEnd);
				d.style.setProperty('--rot', rot);
				d.style.setProperty('--dur', dur);
				d.style.left = xStart;
				confettiContainer.appendChild(d);
			}
			// cleanup after duration
			setTimeout(() => { confettiContainer.innerHTML = ''; }, 9000);
		}
		function updateLeaderboard(lb) { if (!lb || !mpLeaderboard) return; mpLeaderboard.innerHTML = lb.map((p, i) => `<div style="display:flex; justify-content:space-between; gap:.5rem;"><span>${i + 1}. ${escapeHtml(p.name)}</span><span>${p.score}</span></div>`).join('') || '<em style="opacity:.6;">Waiting for players‚Ä¶</em>'; }
		function appendChatMessage(msg, history = false) {
			if (!msg) return;
			console.debug('[chat] recv/append', msg);
			if (!mpChatLog) return;
			const atBottom = mpChatLog.scrollTop + mpChatLog.clientHeight >= mpChatLog.scrollHeight - 4;
			if (mpChatLog.firstElementChild && mpChatLog.firstElementChild.tagName === 'EM') mpChatLog.innerHTML = '';
			const div = document.createElement('div');
			const ts = new Date(msg.ts || Date.now()); const hh = String(ts.getHours()).padStart(2, '0'); const mm = String(ts.getMinutes()).padStart(2, '0');
			div.style.padding = '.18rem 0';
			div.dataset.msgId = msg.id || '';
			div.innerHTML = `<span style="opacity:.45; font-size:.65rem;">${hh}:${mm}</span> <strong style="font-weight:600;">${escapeHtml(msg.name || '')}</strong>: <span>${escapeHtml(msg.text || '')}</span>${msg._pending ? ' <em style=\"opacity:.4;\">(sending)</em>' : ''}`;
			mpChatLog.appendChild(div);
			if (atBottom) mpChatLog.scrollTop = mpChatLog.scrollHeight;
			// If this is a definitive server message matching a prior pending, remove pending flag
			if (msg.id) {
				const pendings = [...mpChatLog.children].filter(el => el.dataset.msgId === '' && /\(sending\)/.test(el.textContent) && el.textContent.includes(msg.text));
				pendings.forEach(p => p.remove());
			}
		}
		function escapeHtml(s) { return s.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;' }[c])); }

		// Timer for multiplayer uses server start + duration
		let mpTimerInt = null;
		function setupMpTimer(q) {
			clearInterval(mpTimerInt); function tick() {
				const now = Date.now(); const elapsed = now - q.start; const left = Math.max(0, q.duration - elapsed); timerDisplay.textContent = (left / 1000).toFixed(1) + 's'; timerDisplay.classList.toggle('low', left < 3000); if (left <= 0) { clearInterval(mpTimerInt); if (pendingReveal && pendingReveal.id === q.id) { applyReveal(pendingReveal.answer); pendingReveal = null; } }
			}
			tick(); mpTimerInt = setInterval(tick, 80);
		}
		let pendingReveal = null;

		// Keyboard shortcuts
		document.addEventListener('keydown', e => {
			if (summaryScreen && !summaryScreen.classList.contains('hidden')) {
				if (e.key === 'Escape') { showStart(); }
				return;
			}
			if (startScreen && !startScreen.classList.contains('hidden')) return; // no shortcuts on start screen
			if (e.key === 'Escape') { showStart(); }
			if (['1', '2', '3', '4'].includes(e.key)) {
				const idx = +e.key - 1; const btn = optionsContainer.children[idx]; if (btn) btn.click();
			}
			if (e.key === 'n' || e.key === 'N') { if (!nextBtn.disabled) nextBtn.click(); }
		});

		function startSession(topics) {
			chosenTopics = topics;
			practiceMode = practiceMode && topics.length === TOPICS.length ? practiceMode : false; // keep only if already toggled
			if (practiceMode) { questionLimit = Infinity; } else { const sel = parseInt(questionCountSelect.value, 10); questionLimit = sel > 0 ? sel : Infinity; }
			autoNextEnabled = !!autoNextToggle.checked;
			// reset session stats
			totalScore = 0; questions = 0; correct = 0; totalAnswerTime = 0; streak = 0; bestStreak = 0; answeredThisSession = 0; refreshStats();
			hide(startScreen); hide(summaryScreen); show(quizScreen);
			if (gradeText) { gradeText.textContent = selectedGradeRange === '1-5' ? '1‚Äì5' : '6‚Äì10'; }
			perQuestionScore.textContent = '+0';
			nextQuestion();
		}

		function nextQuestion() {
			clearTimer();
			nextBtn.disabled = true;
			perQuestionScore.textContent = '+0';
			currentQuestion = generateQuestion();
			questionText.textContent = currentQuestion.text;
			topicLabel.textContent = currentQuestion.topicSymbol + ' ' + currentQuestion.topicLabel;
			renderOptions(currentQuestion);
			timeLeftMs = QUESTION_TIME_MS;
			updateTimerDisplay();
			questionStart = performance.now();
			timerInterval = setInterval(tick, 50);
		}

		function generateQuestion() {
			const maxDigits = selectedGradeRange === '1-5' ? 2 : 3;

			// pick random topic from chosenTopics
			const t = chosenTopics[Math.floor(Math.random() * chosenTopics.length)];
			const { text, answer } = t.generator(maxDigits);

			// generate 3 unique wrong answers
			const options = new Set([answer]);
			while (options.size < 4) {
				let wrong = perturb(answer, t.id);
				options.add(wrong);
			}
			const shuffled = Array.from(options).sort(() => Math.random() - 0.5);
			return { topicId: t.id, topicSymbol: t.symbol, topicLabel: t.label, text, answer, options: shuffled };
		}

		function perturb(ans, topic) {
			// create plausible distractor around the true answer magnitude
			if (topic === 'div') {
				// slight off-by-one or multiply/divide by small factor
				const delta = [1, -1, 2, -2][Math.floor(Math.random() * 4)];
				let v = ans + delta;
				if (v <= 0) v = ans + Math.abs(delta) + 1;
				return v;
			}
			const magnitude = Math.max(2, Math.round(Math.abs(ans) * 0.15));
			let v = ans + (Math.floor(Math.random() * (magnitude * 2 + 1)) - magnitude);
			if (v === ans) v += (Math.random() < 0.5 ? -1 : 1) * (magnitude + 1);
			if (topic === 'mul' && ans > 20) {
				// maybe totally different factor
				if (Math.random() < 0.3) v = ans + (Math.random() < 0.5 ? 10 : -10);
			}
			return v;
		}

		function renderOptions(q) {
			optionsContainer.innerHTML = '';
			q.options.forEach((val, i) => {
				const btn = document.createElement('button');
				btn.className = 'option';
				btn.textContent = val;
				btn.addEventListener('click', () => selectAnswer(btn, val));
				optionsContainer.appendChild(btn);
			});
		}

		function selectAnswer(btn, value) {
			if (nextBtn.disabled === false) return; // already answered
			const elapsed = performance.now() - questionStart;
			clearTimer();
			const correctVal = currentQuestion.answer;
			const children = [...optionsContainer.children];
			children.forEach(b => {
				const val = +b.textContent;
				if (val === correctVal) b.classList.add('correct');
				if (b !== btn && val !== correctVal) b.classList.add('disabled');
			});
			if (value === correctVal) {
				streak++; bestStreak = Math.max(bestStreak, streak);
				correct++;
				const pts = practiceMode ? 0 : calcPoints(elapsed);
				totalScore += pts;
				totalAnswerTime += elapsed;
				perQuestionScore.textContent = '+' + pts;
				btn.classList.add('correct');
			} else {
				streak = 0;
				btn.classList.add('wrong');
			}
			questions++;
			answeredThisSession++;
			refreshStats();
			const reachedLimit = questions >= questionLimit;
			nextBtn.disabled = reachedLimit;
			if (reachedLimit) { setTimeout(showSummary, 600); return; }
			if (answeredThisSession % SUMMARY_EVERY === 0) { setTimeout(showSummary, 700); return; }
			if (autoNextEnabled) { setTimeout(() => { if (!summaryScreen.classList.contains('hidden')) return; if (!document.hidden) nextQuestion(); else nextBtn.disabled = false; }, AUTO_NEXT_DELAY); } else { nextBtn.disabled = false; }
		}

		function calcPoints(elapsedMs) {
			const ratio = Math.min(1, elapsedMs / QUESTION_TIME_MS);
			return Math.max(MIN_POINTS, Math.round(MAX_POINTS - (MAX_POINTS - MIN_POINTS) * ratio));
		}

		function tick() {
			timeLeftMs -= 50;
			if (timeLeftMs <= 0) {
				timeLeftMs = 0;
				updateTimerDisplay();
				clearTimer();
				// auto mark as wrong
				markTimeout();
			} else {
				updateTimerDisplay();
			}
		}

		function markTimeout() {
			streak = 0;
			questions++;
			answeredThisSession++;
			const reachedLimit = questions >= questionLimit;
			const correctVal = currentQuestion.answer;
			[...optionsContainer.children].forEach(b => {
				const val = +b.textContent;
				if (val === correctVal) b.classList.add('correct'); else b.classList.add('disabled');
			});
			perQuestionScore.textContent = '+0';
			refreshStats();
			nextBtn.disabled = reachedLimit;
			if (reachedLimit) { setTimeout(showSummary, 600); return; }
			if (answeredThisSession % SUMMARY_EVERY === 0) { setTimeout(showSummary, 600); return; }
			if (autoNextEnabled) { setTimeout(() => { if (!summaryScreen.classList.contains('hidden')) return; nextQuestion(); }, AUTO_NEXT_DELAY); } else { nextBtn.disabled = false; }
		}

		function updateTimerDisplay() {
			const s = (timeLeftMs / 1000).toFixed(1) + 's';
			timerDisplay.textContent = s;
			timerDisplay.classList.toggle('low', timeLeftMs < 3000);
		}

		function clearTimer() { if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } }

		function refreshStats() {
			totalScoreEl.textContent = totalScore;
			const acc = questions ? Math.round((correct / questions) * 100) : 0;
			accuracyEl.textContent = acc + '%';
			streakEl.textContent = streak;
		}

		function showSummary() {
			hide(quizScreen); show(summaryScreen);
			finalScore.textContent = totalScore;
			sumQuestions.textContent = questions;
			sumCorrect.textContent = correct;
			sumAccuracy.textContent = questions ? Math.round(correct / questions * 100) + '%' : '0%';
			sumAvgTime.textContent = correct ? (totalAnswerTime / correct / 1000).toFixed(1) + 's' : '‚Äî';
			sumBestStreak.textContent = bestStreak;
		}

		function showStart() {
			clearTimer();
			show(startScreen); hide(quizScreen); hide(summaryScreen);
			hide(mpLobby); hide(mpRoom);
		}

		function fullReset() {
			if (!confirm('Reset all scores and progress?')) return;
			clearTimer();
			totalScore = 0; questions = 0; correct = 0; totalAnswerTime = 0; streak = 0; bestStreak = 0; answeredThisSession = 0; practiceMode = false;
			refreshStats();
			showStart();
		}

		function show(elm) { elm.classList.remove('hidden'); }
		function hide(elm) { elm.classList.add('hidden'); }

		// Generators
		function genAddition(maxDigits = 2) {
			const max = Math.pow(10, maxDigits) - 1; const min = 1; // allow up to digit cap
			const a = rand(min, max), b = rand(min, max); return { text: `${a} + ${b} = ?`, answer: a + b };
		}
		function genSubtraction(maxDigits = 2) {
			const max = Math.pow(10, maxDigits) - 1; const min = 1;
			let a = rand(min, max), b = rand(1, Math.max(1, a - 1)); return { text: `${a} ‚àí ${b} = ?`, answer: a - b };
		}
		function genMultiplication(maxDigits = 2) {
			// Grade 1‚Äì5: always 2-digit √ó 1-digit
			// Grade 6‚Äì10: allow 2-digit √ó 1-digit OR 2-digit √ó 2-digit
			if (maxDigits <= 2) {
				const a = rand(10, 99); const b = rand(2, 9);
				return { text: `${a} √ó ${b} = ?`, answer: a * b };
			} else {
				const a = rand(10, 99);
				const twoByOne = Math.random() < 0.5;
				const b = twoByOne ? rand(2, 9) : rand(10, 99);
				return { text: `${a} √ó ${b} = ?`, answer: a * b };
			}
		}
		function genDivision(maxDigits = 2) {
			// Tables constraint: 1‚Äì10 for grade 1‚Äì5, 1‚Äì15 for grade 6‚Äì10
			const dividendMax = Math.pow(10, maxDigits) - 1; // 99 or 999
			const tableMax = maxDigits <= 2 ? 10 : 15;
			let baseDiv = rand(1, tableMax);
			let baseQuo = rand(1, tableMax);
			// Optional scale factor for older grade to allow nicer 2-digit divisors (e.g., 120 √∑ 20)
			let scale = 1;
			if (maxDigits >= 3) {
				scale = Math.random() < 0.4 ? 10 : 1; // 40% chance to scale by 10
			}
			// Ensure within cap; adjust if needed
			let divisor = baseDiv * scale;
			let dividend = baseDiv * baseQuo * scale;
			if (dividend > dividendMax) {
				// Drop scale first, then adjust bases if still too large
				scale = 1;
				divisor = baseDiv;
				dividend = baseDiv * baseQuo;
				if (dividend > dividendMax) {
					// shrink bases deterministically
					baseDiv = Math.max(1, Math.floor(baseDiv / 2));
					baseQuo = Math.max(1, Math.floor(baseQuo / 2));
					divisor = baseDiv;
					dividend = baseDiv * baseQuo;
				}
			}
			// Avoid 0 or trivial 1√∑1 too often: ensure at least one factor >1
			if (baseDiv === 1 && baseQuo === 1) { baseQuo = 2; dividend = baseDiv * baseQuo * scale; }
			return { text: `${dividend} √∑ ${divisor} = ?`, answer: baseQuo };
		}
		function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

		// Initialize UI values
		refreshStats();
		updateTimerDisplay();
	</script>
</body>

</html>